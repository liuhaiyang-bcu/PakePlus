<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤´åƒä¼˜åŒ–æµ‹è¯•</title>
    <link rel="icon" href="img/logo.png" type="image/png">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #4285f4;
        }
        .avatar-preview {
            display: flex;
            gap: 20px;
            align-items: center;
            margin: 20px 0;
        }
        .avatar-item {
            text-align: center;
        }
        .avatar-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #ddd;
            object-fit: cover;
            margin-bottom: 8px;
        }
        .avatar-info {
            font-size: 12px;
            color: #666;
        }
        .upload-area {
            border: 2px dashed #4285f4;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 16px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #3367d6;
            background: #f8f9ff;
        }
        .file-input {
            display: none;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #4285f4;
            color: white;
        }
        .btn-primary:hover {
            background: #3367d6;
        }
        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        .btn-secondary:hover {
            background: #e9ecef;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #4285f4;
            margin-bottom: 4px;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 6px;
            padding: 16px;
            margin: 16px 0;
        }
        .info-box h4 {
            margin-top: 0;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¼ï¸ å¤´åƒè‡ªåŠ¨ä¼˜åŒ–æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ“Š å½“å‰å¤´åƒçŠ¶æ€</h3>
            <div class="avatar-preview">
                <div class="avatar-item">
                    <img id="current-avatar" class="avatar-img" src="img/1.png" alt="å½“å‰å¤´åƒ">
                    <div class="avatar-info">å½“å‰å¤´åƒ</div>
                </div>
                <div class="avatar-item">
                    <img id="optimized-avatar" class="avatar-img" src="img/1.png" alt="ä¼˜åŒ–åå¤´åƒ">
                    <div class="avatar-info">ä¼˜åŒ–å</div>
                </div>
            </div>
            <div id="avatar-stats" class="stats-grid"></div>
            <button class="btn btn-primary" onclick="checkCurrentAvatar()">æ£€æŸ¥å½“å‰å¤´åƒ</button>
            <button class="btn btn-secondary" onclick="optimizeCurrentAvatar()">ä¼˜åŒ–ç°æœ‰å¤´åƒ</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ å¤´åƒä¸Šä¼ æµ‹è¯•</h3>
            <div class="info-box">
                <h4>æµ‹è¯•è¯´æ˜</h4>
                <p>ä¸Šä¼ å¤´åƒå›¾ç‰‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å‹ç¼©åˆ°30KBä»¥ä¸‹ï¼Œå°ºå¯¸è°ƒæ•´ä¸º300x300åƒç´ ï¼Œå¹¶æ¸…ç†æ—§å¤´åƒæ•°æ®ã€‚</p>
            </div>
            <div class="upload-area" onclick="document.getElementById('avatarTestInput').click()">
                <div>ğŸ“· ç‚¹å‡»ä¸Šä¼ å¤´åƒè¿›è¡Œæµ‹è¯•</div>
                <div style="font-size: 12px; color: #666; margin-top: 8px;">
                    æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæœ€å¤§ 20MB
                </div>
                <input type="file" id="avatarTestInput" class="file-input" accept="image/*">
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ å‹ç¼©è®¾ç½®æµ‹è¯•</h3>
            <div style="display: flex; gap: 10px; align-items: center; margin: 16px 0;">
                <label>ç›®æ ‡å¤§å° (KB):</label>
                <input type="number" id="targetSizeInput" value="30" min="5" max="200" style="width: 80px; padding: 4px;">
                <label>æœ€å¤§å°ºå¯¸:</label>
                <input type="number" id="maxSizeInput" value="300" min="100" max="800" style="width: 80px; padding: 4px;">
                <button class="btn btn-secondary" onclick="updateSettings()">æ›´æ–°è®¾ç½®</button>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ˆ ä¼˜åŒ–ç»Ÿè®¡</h3>
            <div id="optimization-stats" class="stats-grid"></div>
            <button class="btn btn-primary" onclick="showStats()">æ˜¾ç¤ºç»Ÿè®¡</button>
            <button class="btn btn-secondary" onclick="clearStats()">æ¸…é™¤ç»Ÿè®¡</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
            <div id="log" class="log-area"></div>
            <button class="btn btn-secondary" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>

        <div class="test-section">
            <h3>ğŸ—‘ï¸ æ•°æ®æ¸…ç†æµ‹è¯•</h3>
            <button class="btn btn-secondary" onclick="cleanupTempData()">æ¸…ç†ä¸´æ—¶æ•°æ®</button>
            <button class="btn btn-secondary" onclick="resetAvatar()">é‡ç½®å¤´åƒ</button>
            <button class="btn btn-secondary" onclick="showStorageUsage()">æ˜¾ç¤ºå­˜å‚¨å ç”¨</button>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="js/storage.js"></script>
    <script src="js/avatar-optimizer.js"></script>

    <script>
        let testOptimizer;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            testOptimizer = window.avatarOptimizer;
            log('å¤´åƒä¼˜åŒ–æµ‹è¯•å·¥å…·å·²åˆå§‹åŒ–');
            checkCurrentAvatar();
        });

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logArea = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // æ£€æŸ¥å½“å‰å¤´åƒ
        function checkCurrentAvatar() {
            try {
                const stats = testOptimizer.getOptimizationStats();
                log('=== å½“å‰å¤´åƒçŠ¶æ€ ===');
                log(`æœ‰å¤´åƒ: ${stats.hasAvatar ? 'æ˜¯' : 'å¦'}`);
                
                if (stats.hasAvatar) {
                    log(`å·²ä¼˜åŒ–: ${stats.isOptimized ? 'æ˜¯' : 'å¦'}`);
                    log(`å½“å‰å¤§å°: ${stats.currentSizeKB}KB`);
                    log(`ç›®æ ‡å¤§å°: ${stats.targetSizeKB}KB`);
                    log(`éœ€è¦ä¼˜åŒ–: ${stats.needsOptimization ? 'æ˜¯' : 'å¦'}`);
                    
                    // æ›´æ–°å¤´åƒæ˜¾ç¤º
                    const userInfo = StorageManager.getUserInfo();
                    if (userInfo.avatar) {
                        document.getElementById('current-avatar').src = userInfo.avatar;
                    }
                }
                
                updateAvatarStats(stats);
                
            } catch (error) {
                log(`æ£€æŸ¥å¤´åƒå¤±è´¥: ${error.message}`);
            }
        }

        // æ›´æ–°å¤´åƒç»Ÿè®¡æ˜¾ç¤º
        function updateAvatarStats(stats) {
            const container = document.getElementById('avatar-stats');
            
            if (!stats.hasAvatar) {
                container.innerHTML = '<div class="stat-card"><div class="stat-value">æ— </div><div class="stat-label">å½“å‰å¤´åƒ</div></div>';
                return;
            }
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.currentSizeKB}</div>
                    <div class="stat-label">å½“å‰å¤§å° (KB)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.targetSizeKB}</div>
                    <div class="stat-label">ç›®æ ‡å¤§å° (KB)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.isOptimized ? 'âœ…' : 'âŒ'}</div>
                    <div class="stat-label">å·²ä¼˜åŒ–</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.needsOptimization ? 'éœ€è¦' : 'æ— éœ€'}</div>
                    <div class="stat-label">ä¼˜åŒ–çŠ¶æ€</div>
                </div>
            `;
        }

        // ä¼˜åŒ–ç°æœ‰å¤´åƒ
        async function optimizeCurrentAvatar() {
            try {
                log('å¼€å§‹ä¼˜åŒ–ç°æœ‰å¤´åƒ...');
                
                const result = await testOptimizer.optimizeExistingAvatar();
                
                if (result.optimized) {
                    log(`âœ… ä¼˜åŒ–å®Œæˆ: ${result.originalSizeKB}KB â†’ ${result.newSizeKB}KB`);
                    log(`å‹ç¼©ç‡: ${result.compressionRatio}%`);
                    
                    // æ›´æ–°æ˜¾ç¤º
                    const userInfo = StorageManager.getUserInfo();
                    document.getElementById('optimized-avatar').src = userInfo.avatar;
                    
                    checkCurrentAvatar();
                } else {
                    log(`æ— éœ€ä¼˜åŒ–: ${result.reason}`);
                }
                
            } catch (error) {
                log(`ä¼˜åŒ–å¤±è´¥: ${error.message}`);
            }
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('avatarTestInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            log(`å¼€å§‹å¤„ç†ä¸Šä¼ çš„å¤´åƒ: ${file.name} (${Math.round(file.size / 1024)}KB)`);
            
            try {
                // æ˜¾ç¤ºåŸå§‹å¤´åƒ
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('current-avatar').src = e.target.result;
                };
                reader.readAsDataURL(file);
                
                // å‹ç¼©å¤´åƒ
                const compressedResult = await testOptimizer.compressAvatar(file);
                
                // æ¸…ç†æ—§å¤´åƒ
                const cleanupResult = testOptimizer.cleanupOldAvatar(compressedResult.data);
                
                // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
                StorageManager.updateUserInfo({
                    avatar: compressedResult.data
                });
                
                // æ˜¾ç¤ºå‹ç¼©åçš„å¤´åƒ
                document.getElementById('optimized-avatar').src = compressedResult.data;
                
                // è®°å½•ç»“æœ
                const originalKB = Math.round(file.size / 1024);
                const compressedKB = Math.round(compressedResult.size / 1024);
                const savedKB = originalKB - compressedKB;
                
                log(`âœ… å‹ç¼©å®Œæˆ: ${originalKB}KB â†’ ${compressedKB}KB (èŠ‚çœ${savedKB}KB)`);
                log(`å‹ç¼©ç‡: ${compressedResult.compressionRatio}%`);
                log(`å°ºå¯¸: ${compressedResult.width}x${compressedResult.height}`);
                
                if (cleanupResult.cleaned) {
                    log(`ğŸ—‘ï¸ æ¸…ç†æ—§å¤´åƒï¼Œé‡Šæ”¾ç©ºé—´: ${cleanupResult.freedSpaceKB}KB`);
                }
                
                checkCurrentAvatar();
                
            } catch (error) {
                log(`å¤„ç†å¤±è´¥: ${error.message}`);
            }
            
            e.target.value = '';
        });

        // æ›´æ–°è®¾ç½®
        function updateSettings() {
            const targetSize = parseInt(document.getElementById('targetSizeInput').value);
            const maxSize = parseInt(document.getElementById('maxSizeInput').value);
            
            if (testOptimizer) {
                testOptimizer.maxSizeKB = targetSize;
                testOptimizer.maxDimension = maxSize;
                log(`è®¾ç½®å·²æ›´æ–°: ç›®æ ‡å¤§å°=${targetSize}KB, æœ€å¤§å°ºå¯¸=${maxSize}px`);
            }
        }

        // æ˜¾ç¤ºç»Ÿè®¡
        function showStats() {
            const container = document.getElementById('optimization-stats');
            
            // è®¡ç®—å­˜å‚¨å ç”¨
            let totalSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length;
                }
            }
            
            const userInfo = StorageManager.getUserInfo();
            const avatarSize = userInfo.avatar ? Math.round((userInfo.avatar.length * 3) / 4 / 1024) : 0;
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${avatarSize}</div>
                    <div class="stat-label">å¤´åƒå¤§å° (KB)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round(totalSize / 1024)}</div>
                    <div class="stat-label">æ€»å­˜å‚¨ (KB)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avatarSize > 0 ? Math.round(avatarSize / totalSize * 1024 * 100) : 0}%</div>
                    <div class="stat-label">å¤´åƒå æ¯”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Object.keys(localStorage).length}</div>
                    <div class="stat-label">å­˜å‚¨é¡¹æ•°</div>
                </div>
            `;
            
            log('ç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–°');
        }

        // æ¸…é™¤ç»Ÿè®¡
        function clearStats() {
            document.getElementById('optimization-stats').innerHTML = '';
            log('ç»Ÿè®¡ä¿¡æ¯å·²æ¸…é™¤');
        }

        // æ¸…ç†ä¸´æ—¶æ•°æ®
        function cleanupTempData() {
            testOptimizer._cleanupTempAvatarData();
            log('ä¸´æ—¶æ•°æ®å·²æ¸…ç†');
        }

        // é‡ç½®å¤´åƒ
        function resetAvatar() {
            if (confirm('ç¡®å®šè¦é‡ç½®å¤´åƒå—ï¼Ÿ')) {
                StorageManager.updateUserInfo({
                    avatar: 'img/1.png'
                });
                
                document.getElementById('current-avatar').src = 'img/1.png';
                document.getElementById('optimized-avatar').src = 'img/1.png';
                
                log('å¤´åƒå·²é‡ç½®ä¸ºé»˜è®¤å¤´åƒ');
                checkCurrentAvatar();
            }
        }

        // æ˜¾ç¤ºå­˜å‚¨å ç”¨
        function showStorageUsage() {
            log('=== å­˜å‚¨å ç”¨è¯¦æƒ… ===');
            
            let totalSize = 0;
            const items = [];
            
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    const size = localStorage[key].length;
                    totalSize += size;
                    items.push({
                        key: key,
                        size: size,
                        sizeKB: Math.round(size / 1024)
                    });
                }
            }
            
            // æŒ‰å¤§å°æ’åº
            items.sort((a, b) => b.size - a.size);
            
            log(`æ€»å­˜å‚¨å¤§å°: ${Math.round(totalSize / 1024)}KB`);
            log('å„é¡¹å ç”¨:');
            
            items.slice(0, 10).forEach(item => {
                log(`  ${item.key}: ${item.sizeKB}KB`);
            });
            
            if (items.length > 10) {
                log(`  ... è¿˜æœ‰ ${items.length - 10} é¡¹`);
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ‰æ•°è§„åˆ’ä¸“æ³¨æ—¶é’Ÿ</title>
    <link rel="icon" href="img/logo.png" type="image/png">
    <link rel="stylesheet" href="css/pomodoro.css">
    <link rel="stylesheet" href="css/pomodorodark.css">
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* é˜²æ­¢æ–‡æœ¬é€‰æ‹©å’Œå¤åˆ¶ */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="light-theme">
    <!-- å¤´éƒ¨ç”¨æˆ·ä¿¡æ¯ -->
    <header class="user-header">
        <div class="user-info">
            <div class="user-avatar-container">
                <img id="user-avatar" class="user-avatar" src="img/1.png" alt="ç”¨æˆ·å¤´åƒ">
            </div>
            <div class="user-details">
                <span id="user-nickname" class="user-nickname">æœªç™»å½•</span>
                <div class="points-info">
                    <span class="points-icon star-icon"><i class="fas fa-star"></i></span>
                    <span id="user-points">0</span>
                </div>
            </div>
        </div>
        <button class="back-btn" onclick="window.location.href='index.html'">
            <i class="fas fa-arrow-left"></i>
            è¿”å›æœ€è¿‘è¦åš
        </button>
    </header>

    <div class="container">
        <!-- ä¾§è¾¹æ  (æ¡Œé¢ç«¯) -->
        <div class="sidebar">
            <h2><i class="fas fa-stopwatch" style="color:#ff6347;margin-right:8px;"></i>æœ‰æ•°è§„åˆ’ä¸“æ³¨æ—¶é’Ÿ</h2>
            
            <!-- æ·»åŠ äº‹ä»¶è¡¨å• -->
            <div class="event-form">
                <h3 style="margin-bottom: 15px; color: #667eea;">æ·»åŠ æ–°äº‹ä»¶</h3>
                <div class="form-group">
                    <label>äº‹ä»¶åç§°</label>
                    <input type="text" id="eventName" placeholder="è¾“å…¥äº‹ä»¶åç§°">
                </div>
                <div class="form-group">
                    <label>ä¸“æ³¨æ—¶é•¿ (åˆ†é’Ÿ)</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="eventDuration" style="flex: 1;">
                            <option value="25">25åˆ†é’Ÿ</option>
                            <option value="30">30åˆ†é’Ÿ</option>
                            <option value="45">45åˆ†é’Ÿ</option>
                            <option value="60">60åˆ†é’Ÿ</option>
                            <option value="custom">è‡ªå®šä¹‰æ—¶é•¿</option>
                        </select>
                        <input type="number" id="customDuration" placeholder="è‡ªå®šä¹‰åˆ†é’Ÿ" style="display: none; width: 120px;" min="1" max="180">
                    </div>
                </div>
                <button class="btn" onclick="addEvent()" style="width: 100%;">æ·»åŠ äº‹ä»¶</button>
            </div>

            <!-- äº‹ä»¶åˆ—è¡¨ -->
            <div class="event-list" id="eventList">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats">
                <h3>ä»Šæ—¥ç»Ÿè®¡</h3>   
                <div class="stat-item"> 
                     <span><i class="fas fa-list-check" style="color:#667eea;"></i> å½“å‰äº‹ä»¶:</span>
                     <span id="currentEventName">æ— </span>
                </div>
                <div class="stat-item">
                    <span><i class="fas fa-check-circle" style="color:#ff6347;"></i> ä»Šæ—¥å®Œæˆ:</span>
                    <span id="completedPomodoros">0</span>
                </div>
                <div class="stat-item">
                    <span><i class="fas fa-fire" style="color:#ff9800;"></i> ä¸“æ³¨æ—¶é•¿:</span>
                    <span id="totalTime">0åˆ†é’Ÿ</span>
                </div>
                <div class="stat-item">
                    <span><i class="fas fa-bullseye" style="color:#4caf50;"></i> ä»Šæ—¥ç›®æ ‡:</span>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span id="dailyTarget">0åˆ†é’Ÿ</span>
                        <button class="btn btn-small" onclick="setDailyTarget()"><i class="fas fa-pen"></i> è®¾ç½®</button>
                    </div>
                </div>
                <div class="stat-item">
                    <span><i class="fas fa-trophy" style="color:#ffd700;"></i> ç›®æ ‡è¾¾æˆç‡:</span>
                    <span id="targetCompletionRate">0%</span>
                </div>

                <h3>æ€»ç»Ÿè®¡</h3>
                <div class="stat-item">
                    <span><i class="fas fa-apple-whole" style="color:#ff6347;"></i> æ€»ç•ªèŒ„æ•°:</span>
                    <span id="totalPomodoros">0</span>
                </div>
                <div class="stat-item">
                    <span><i class="fas fa-award" style="color:#ffd700;"></i> æ€»ç›®æ ‡è¾¾æˆç‡:</span>
                    <span id="totalCompletionRate">0%</span>
                </div>
                <div class="stat-item">
                    <span><i class="fas fa-fire" style="color:#ff9800;"></i> æ€»ä¸“æ³¨æ—¶é•¿:</span>
                    <span id="totalFocusTime">0åˆ†é’Ÿ</span>
                </div>
            </div>

            <!-- æ•°æ®ç®¡ç† -->
            <div class="data-management">
                <h3 style="color: #667eea; margin-bottom: 15px;">ä¸“æ³¨æ—¶é’Ÿæ•°æ®ç®¡ç†</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn secondary" onclick="showEventStats()" style="width: 100%;">
                        ğŸ“Š æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡
                    </button>
                    <button class="btn secondary" onclick="showDailyStats()" style="width: 100%;">
                        ğŸ“… æŸ¥çœ‹æ¯æ—¥ç»Ÿè®¡
                    </button>
                    <button class="btn secondary" onclick="showExportHint();exportData()" style="width: 100%;">
                        ğŸ“¥ å¯¼å‡ºæ•°æ®
                    </button>
                    <div style="position: relative;">
                        <input type="file" id="importFile" accept=".json,application/json" style="display: none;" onchange="importData(event)">
                        <button class="btn secondary" onclick="showImportFileHint();showImportHint();document.getElementById('importFile').click()" style="width: 100%;">
                            ğŸ“¤ å¯¼å…¥æ•°æ®
                        </button>
                    </div>
                </div>
            </div>
            <div class="sidebar-resizer"></div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="timer-container">
                <div class="timer-label" id="timerLabel">
                    <i class="fas fa-stopwatch" style="color:#ff6347;margin-right:8px;"></i>å‡†å¤‡å¼€å§‹ä¸“æ³¨
                </div>
                
                <!-- è¿›åº¦ç¯ -->
                <svg class="progress-ring" width="200" height="200">
                    <circle class="progress-ring-circle" cx="100" cy="100" r="90" 
                            stroke-dasharray="565.48" stroke-dashoffset="565.48" id="progressCircle">
                    </circle>
                </svg>
                
                <div class="timer-display" id="timerDisplay">25:00</div>
                
                <div class="current-event" id="currentEvent" style="display: none;">
                    <i class="fas fa-list-check" style="color:#667eea;margin-right:4px;"></i>å½“å‰äº‹ä»¶: <span id="currentEventDisplay">æ— </span>
                </div>

                <div>
                    <button class="btn" id="startBtn" onclick="startTimer()">
                        <i class="fas fa-play"></i> å¼€å§‹
                    </button>
                    <button class="btn secondary" id="pauseBtn" onclick="pauseTimer()" style="display: none;">
                        <i class="fas fa-pause"></i> æš‚åœ
                    </button>
                    <button class="btn secondary" onclick="resetTimer()">
                        <i class="fas fa-rotate-left"></i> é‡ç½®
                    </button>
                    <button class="btn success" onclick="completePomodoro()" id="completeBtn" style="display: none;">
                        <i class="fas fa-check"></i> å®Œæˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯å¯¼èˆªæ  -->
    <div class="mobile-nav">
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showMobileSection('timer')">
                <i class="fas fa-stopwatch"></i> è®¡æ—¶å™¨
            </button>
            <button class="nav-btn" onclick="showMobileSection('events')">
                <i class="fas fa-calendar-plus"></i> äº‹ä»¶ç®¡ç†
            </button>
            <button class="nav-btn" onclick="showMobileSection('stats')">
                <i class="fas fa-chart-bar"></i> ç»Ÿè®¡
            </button>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯æ¨¡æ€æ¡† -->
    <div class="mobile-modal" id="mobileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle"><i class="fas fa-calendar-plus" style="margin-right:6px;"></i>äº‹ä»¶ç®¡ç†</h3>
                <button class="close-btn" onclick="closeMobileModal()">&times;</button>
            </div>
            <div id="modalContent">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
    </div>

    <!-- ä¸“æ³¨æ¨¡å¼æ‚¬æµ®æŒ‡ç¤ºå™¨ -->
    <div class="focus-floating-indicator" id="focus-floating-indicator" onclick="openPomodoroTracker()">
        <i class="fas fa-hourglass-half"></i>
        <span class="focus-floating-text">ä¸“æ³¨è¿›è¡Œä¸­</span>
        <span class="timer-mini" id="floating-timer"><i class="fas fa-stopwatch"></i> 25:00</span>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/pomodoro.js"></script>
    <script src="js/system-notifications.js"></script>
    <script>
        // æ·»åŠ ç”¨æˆ·æ— æ“ä½œæ£€æµ‹å˜é‡
        let inactivityTimer;
        let warningTimer;
        let countdownInterval;
        let countdownSeconds = 2;
        const INACTIVITY_TIMEOUT = 30000; // 30ç§’æ— æ“ä½œè¶…æ—¶
        const WARNING_TIME = 28000; // 28ç§’æ—¶æ˜¾ç¤ºè­¦å‘Š

        // æ˜¾ç¤ºè·³è½¬è­¦å‘Š
        function showRedirectWarning() {
            // å¦‚æœé¡µé¢ä¸­æœ‰é€šçŸ¥æ˜¾ç¤ºå‡½æ•°ï¼Œä½¿ç”¨å®ƒæ¥æ˜¾ç¤ºè­¦å‘Š
            if (typeof showNotification === 'function') {
                showNotification(`é¡µé¢å°†åœ¨${countdownSeconds}ç§’åè·³è½¬åˆ°ä¸»é¡µ`, 'warning');
            } else {
                // å¦‚æœæ²¡æœ‰é€šçŸ¥å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„è­¦å‘Šå…ƒç´ 
                let warningDiv = document.getElementById('inactivity-warning');
                if (!warningDiv) {
                    warningDiv = document.createElement('div');
                    warningDiv.id = 'inactivity-warning';
                    warningDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> é¡µé¢å°†åœ¨<span id="countdown-number">${countdownSeconds}</span>ç§’åè·³è½¬åˆ°ä¸»é¡µ`;
                    warningDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background-color: #fff3cd;
                        color: #856404;
                        border: 1px solid #ffeaa7;
                        border-radius: 4px;
                        padding: 12px 20px;
                        z-index: 10000;
                        font-size: 14px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    `;
                    document.body.appendChild(warningDiv);
                }
                
                // å¯åŠ¨å€’è®¡æ—¶æ›´æ–°
                startCountdownUpdate();
            }
        }

        // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
        function startCountdownUpdate() {
            countdownSeconds = 30; // é‡ç½®å€’è®¡æ—¶ä¸º30ç§’
            updateCountdownDisplay();
            
            // æ¯ç§’æ›´æ–°ä¸€æ¬¡å€’è®¡æ—¶æ˜¾ç¤º
            countdownInterval = setInterval(() => {
                countdownSeconds--;
                updateCountdownDisplay();
                
                // å½“å€’è®¡æ—¶ç»“æŸæ—¶æ¸…é™¤interval
                if (countdownSeconds <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
        }

        // æ›´æ–°å€’è®¡æ—¶æ•°å­—æ˜¾ç¤º
        function updateCountdownDisplay() {
            // å°è¯•æ›´æ–°é€šçŸ¥ä¸­çš„å€’è®¡æ—¶ï¼ˆå¦‚æœä½¿ç”¨çš„æ˜¯é¡µé¢é€šçŸ¥ç³»ç»Ÿï¼‰
            if (typeof updateNotification === 'function') {
                // è¿™é‡Œå‡è®¾æœ‰æ›´æ–°é€šçŸ¥çš„å‡½æ•°
            }
            
            // æ›´æ–°é¡µé¢ä¸Šæ˜¾ç¤ºçš„å€’è®¡æ—¶
            const countdownElement = document.getElementById('countdown-number');
            if (countdownElement) {
                countdownElement.textContent = countdownSeconds;
            }
        }

        // é‡ç½®æ— æ“ä½œè®¡æ—¶å™¨
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(warningTimer);
            clearInterval(countdownInterval);
            
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„è­¦å‘Šå…ƒç´ 
            const warningDiv = document.getElementById('inactivity-warning');
            if (warningDiv) {
                warningDiv.remove();
            }
            
            // é‡ç½®å€’è®¡æ—¶ç§’æ•°
            countdownSeconds = 2;
            
            // è®¾ç½®è­¦å‘Šè®¡æ—¶å™¨ï¼ˆ4ç§’åï¼‰
            warningTimer = setTimeout(showRedirectWarning, WARNING_TIME);
            
            // è®¾ç½®è·³è½¬è®¡æ—¶å™¨ï¼ˆ6ç§’åï¼‰
            inactivityTimer = setTimeout(redirectToIntroPage, INACTIVITY_TIMEOUT);
        }

        // è·³è½¬åˆ°é¦–é¡µ
        function redirectToIntroPage() {
            window.location.href = 'index.html';
        }

        // åˆå§‹åŒ–æ— æ“ä½œæ£€æµ‹
        function initInactivityDetection() {
            // ç›‘å¬å„ç§ç”¨æˆ·æ´»åŠ¨äº‹ä»¶
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'touchmove'];
            events.forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });
            
            // åˆå§‹åŒ–è®¡æ—¶å™¨
            resetInactivityTimer();
        }

        // ä¸»é¢˜ç®¡ç†å‡½æ•° - ä»storage.jsè·å–è®¾ç½®ï¼Œä¸ä¸»åº”ç”¨ä¿æŒä¸€è‡´
        function updateThemeFromSettings() {
            if (!window.StorageManager) {
                console.warn('StorageManager not available, using default theme');
                return;
            }
            
            const settings = StorageManager.getSettings();
            const theme = settings.theme || 'system';
            
            // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
            document.body.classList.remove('light-theme', 'dark-theme', 'dark-mode');
            
            // æ ¹æ®è®¾ç½®åº”ç”¨ä¸»é¢˜
            if (theme === 'dark') {
                document.body.classList.add('dark-theme', 'dark-mode');
            } else if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else if (theme === 'auto' || theme === 'system') {
                // è‡ªåŠ¨æ¨¡å¼ï¼šæ ¹æ®æ—¶é—´åˆ¤æ–­
                const currentHour = new Date().getHours();
                const isDarkMode = currentHour >= 18 || currentHour < 6;
                
                if (isDarkMode) {
                    document.body.classList.add('dark-theme', 'dark-mode');
                } else {
                    document.body.classList.add('light-theme');
                }
            }
            
            // è®¾ç½®HTMLå…ƒç´ çš„dataå±æ€§ï¼Œä¾¿äºCSSé€‰æ‹©å™¨ä½¿ç”¨
            const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
        }

        // ç›‘å¬ä¸»é¢˜å˜åŒ–å’Œç”¨æˆ·ä¿¡æ¯å˜åŒ–
        function setupThemeListener() {
            // ç›‘å¬storageå˜åŒ–
            window.addEventListener('storage', function(e) {
                if (e.key === 'schedule_app_data' || e.key === 'userNickname' || e.key === 'userAvatar') {
                    updateThemeFromSettings();
                    loadUserInfo(); // åŒæ—¶æ›´æ–°ç”¨æˆ·ä¿¡æ¯
                }
            });
            
            // ç›‘å¬ä¸»é¢˜å˜åŒ–äº‹ä»¶ï¼ˆæ¥è‡ªä¸»åº”ç”¨ï¼‰
            document.addEventListener('themechange', function(e) {
                const theme = e.detail.theme;
                document.body.classList.remove('light-theme', 'dark-theme', 'dark-mode');
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme', 'dark-mode');
                } else {
                    document.body.classList.add('light-theme');
                }
                document.documentElement.setAttribute('data-theme', theme);
            });
            
            // ç›‘å¬ç”¨æˆ·ä¿¡æ¯æ›´æ–°äº‹ä»¶
            document.addEventListener('userInfoUpdate', function() {
                loadUserInfo();
            });
            
            // ç›‘å¬ç”¨æˆ·ç™»å½•çŠ¶æ€å˜åŒ–äº‹ä»¶
            window.addEventListener('userLoginStateChanged', function(e) {
                loadUserInfo();
            });
            
            // å®šæœŸæ£€æŸ¥ä¸»é¢˜è®¾ç½®å’Œç”¨æˆ·ä¿¡æ¯ï¼ˆä»¥é˜²å…¶ä»–é¡µé¢ä¿®æ”¹äº†è®¾ç½®ï¼‰
            setInterval(function() {
                updateThemeFromSettings();
                loadUserInfo();
            }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // ç›‘å¬ç”¨æˆ·å¤´åƒæ›´æ–°äº‹ä»¶
        window.addEventListener('userAvatarUpdated', function(e) {
            const avatarData = e.detail.avatar;
            const avatarElement = document.getElementById('user-avatar');
            if (avatarElement) {
                avatarElement.src = avatarData;
            }
        });
        
        // ç›‘å¬å­˜å‚¨å˜åŒ–äº‹ä»¶ï¼Œç”¨äºè·¨æ ‡ç­¾é¡µåŒæ­¥
        window.addEventListener('storage', function(e) {
            if (e.key === 'userAvatar') {
                loadUserInfo();
            }
        });
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        function loadUserInfo() {
            if (!window.StorageManager) {
                console.warn('StorageManager not available');
                return;
            }
            
            // ä»localStorageè·å–å½“å‰ç™»å½•çš„æ˜µç§°å’Œå¤´åƒ
            const currentNickname = localStorage.getItem('userNickname') || 'æœªç™»å½•';
            const currentAvatar = localStorage.getItem('userAvatar');
            const points = StorageManager.getPoints();
            
            // æ›´æ–°ç”¨æˆ·æ˜µç§°
            const nicknameElement = document.getElementById('user-nickname');
            if (nicknameElement) {
                nicknameElement.textContent = currentNickname;
            }
            
            // æ›´æ–°ç”¨æˆ·å¤´åƒ
            const avatarElement = document.getElementById('user-avatar');
            if (avatarElement) {
                let avatarSrc = currentAvatar;
                // å¦‚æœå¤´åƒä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                if (!avatarSrc) {
                    avatarSrc = 'img/1.png';
                }
                avatarElement.src = avatarSrc;
                
                // å¤„ç†å¤´åƒåŠ è½½å¤±è´¥çš„æƒ…å†µ
                avatarElement.onerror = function() {
                    this.src = 'img/1.png';
                };
            }
            
            // æ›´æ–°ç§¯åˆ†
            const pointsElement = document.getElementById('user-points');
            if (pointsElement) {
                const pointsValue = points || 0;
                pointsElement.textContent = pointsValue;
            }
        }
        
        // ç«‹å³åˆå§‹åŒ–ä¸»é¢˜å’Œç”¨æˆ·ä¿¡æ¯ï¼ˆä¸ç­‰å¾…DOMContentLoadedï¼‰
        updateThemeFromSettings();
        
        // å°è¯•ç«‹å³åŠ è½½ç”¨æˆ·ä¿¡æ¯
        setTimeout(loadUserInfo, 100); // å»¶è¿Ÿ100msç¡®ä¿DOMå·²åŠ è½½
        
        // é¡µé¢åŠ è½½å®Œæˆåè®¾ç½®ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // é˜²æ­¢é¡µé¢å†…å®¹è¢«éšæ„å¤åˆ¶
            // ç¦ç”¨æ–‡æœ¬é€‰æ‹©
            document.body.style.userSelect = 'none';
            document.body.style.webkitUserSelect = 'none';
            document.body.style.mozUserSelect = 'none';
            document.body.style.msUserSelect = 'none';
            
            // ç¦ç”¨è§¦æ‘¸é€‰æ‹©
            document.body.style.webkitTouchCallout = 'none';
            
            // é˜»æ­¢å³é”®èœå•
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // é˜»æ­¢å¤åˆ¶æ“ä½œ
            document.addEventListener('copy', function(e) {
                e.preventDefault();
                return false;
            });
            
            // é˜»æ­¢å‰ªåˆ‡æ“ä½œ
            document.addEventListener('cut', function(e) {
                e.preventDefault();
                return false;
            });
            
            // é˜»æ­¢æ‹–æ‹½é€‰æ‹©
            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
                return false;
            });
            
            // é˜»æ­¢é”®ç›˜å¿«æ·é”®å¤åˆ¶
            document.addEventListener('keydown', function(e) {
                // é˜»æ­¢ Ctrl+C, Ctrl+X, Ctrl+A
                if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'x' || e.key === 'a')) {
                    e.preventDefault();
                    return false;
                }
            });

            setupThemeListener();
            loadUserInfo(); // å†æ¬¡åŠ è½½ç”¨æˆ·ä¿¡æ¯ç¡®ä¿æ­£ç¡®æ˜¾ç¤º
            
            // åˆå§‹åŒ–æ— æ“ä½œæ£€æµ‹
            initInactivityDetection();
        });

        /**
         * é€šç”¨æ–‡ä»¶ä¸‹è½½æ–¹æ³•ï¼Œå…¼å®¹HBuilderXæ‰“åŒ…å’Œæµè§ˆå™¨
         * @param {string} url ä¸‹è½½é“¾æ¥
         * @param {string} filename ä¿å­˜æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰
         */
        function downloadFile(url, filename) {
            if (window.plus) {
                // ç”³è¯·å­˜å‚¨æƒé™
                plus.android.requestPermissions(
                    ["android.permission.WRITE_EXTERNAL_STORAGE"],
                    function(e) {
                        // æƒé™ç”³è¯·æˆåŠŸ
                        let dtask = plus.downloader.createDownload(url, {
                            filename: "_downloads/" + (filename || url.split('/').pop())
                        }, function(d, status) {
                            if (status == 200) {
                                plus.nativeUI.toast("ä¸‹è½½æˆåŠŸï¼š" + d.filename);
                                // ä¸‹è½½å®Œæˆåè‡ªåŠ¨æ‰“å¼€æ–‡ä»¶
                                plus.runtime.openFile(d.filename);
                            } else {
                                plus.nativeUI.toast("ä¸‹è½½å¤±è´¥");
                            }
                        });
                        dtask.start();
                    },
                    function(e) {
                        plus.nativeUI.toast("æœªè·å¾—å­˜å‚¨æƒé™ï¼Œæ— æ³•ä¸‹è½½");
                    }
                );
            } else {
                // æµè§ˆå™¨ç¯å¢ƒï¼Œé™çº§å¤„ç†
                fetch(url)
                    .then(res => res.blob())
                    .then(blob => {
                        const a = document.createElement('a');
                        a.href = window.URL.createObjectURL(blob);
                        a.download = filename || url.split('/').pop();
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(a.href);
                    })
                    .catch(() => {
                        window.open(url, '_blank');
                    });
            }
        }
    </script>
    <script>
    // ä¾§è¾¹æ å®½åº¦æ‹–æ‹½åŠŸèƒ½ï¼ˆä»…æ¡Œé¢ç«¯ï¼‰
    (function() {
        const sidebar = document.querySelector('.sidebar');
        const resizer = document.querySelector('.sidebar-resizer');
        const mainContent = document.querySelector('.main-content');
        if (!sidebar || !resizer) return;
        let isDragging = false;
        let startX = 0;
        let startWidth = 0;
        const minWidth = 260;
        const maxWidth = 800;
        // é¡µé¢åŠ è½½æ—¶æ¢å¤å®½åº¦
        if (window.innerWidth >= 1024) {
            const savedWidth = localStorage.getItem('sidebarWidth');
            if (savedWidth) {
                sidebar.style.width = savedWidth + 'px';
                if (mainContent) {
                    mainContent.style.width = `calc(100% - ${savedWidth}px)`;
                }
            }
        }
        resizer.addEventListener('mousedown', function(e) {
            if (window.innerWidth < 1024) return;
            isDragging = true;
            startX = e.clientX;
            startWidth = sidebar.offsetWidth;
            document.body.style.cursor = 'ew-resize';
            document.body.style.userSelect = 'none';
        });
        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            let newWidth = startWidth + (e.clientX - startX);
            newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
            sidebar.style.width = newWidth + 'px';
            if (mainContent) {
                mainContent.style.width = `calc(100% - ${newWidth}px)`;
            }
            // æ‹–åŠ¨æ—¶å®æ—¶ä¿å­˜å®½åº¦
            localStorage.setItem('sidebarWidth', newWidth);
        });
        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });

        // è§¦æ‘¸æ”¯æŒï¼ˆå®‰å“æ‰‹æœº/å¹³æ¿ï¼‰
        resizer.addEventListener('touchstart', function(e) {
            if (window.innerWidth < 1024) return;
            if (!e.touches || e.touches.length !== 1) return;
            isDragging = true;
            startX = e.touches[0].clientX;
            startWidth = sidebar.offsetWidth;
            document.body.style.userSelect = 'none';
            // é˜»æ­¢é¡µé¢æ»šåŠ¨
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchmove', function(e) {
            if (!isDragging) return;
            if (!e.touches || e.touches.length !== 1) return;
            let clientX = e.touches[0].clientX;
            let newWidth = startWidth + (clientX - startX);
            newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
            sidebar.style.width = newWidth + 'px';
            if (mainContent) {
                mainContent.style.width = `calc(100% - ${newWidth}px)`;
            }
            localStorage.setItem('sidebarWidth', newWidth);
            // é˜»æ­¢é¡µé¢æ»šåŠ¨
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchend', function() {
            if (isDragging) {
                isDragging = false;
                document.body.style.userSelect = '';
            }
        });
    })();
    </script>
    <script>
function showImportFileHint() {
    if (window.showNotification) {
        showNotification('è¯·é€šè¿‡æ–‡ä»¶ç®¡ç†å™¨é€‰æ‹© JSON æ–‡ä»¶å¯¼å…¥', 'info');
    } else {
        alert('è¯·é€šè¿‡æ–‡ä»¶ç®¡ç†å™¨é€‰æ‹© JSON æ–‡ä»¶å¯¼å…¥');
    }
}
function showExportHint() {
    if (window.showNotification) {
        showNotification('ä¸“æ³¨æ—¶é’Ÿæ•°æ®å¯¼å‡ºæˆåŠŸï¼Œå¯é€šè¿‡è®¾ç½®é¡µé¢çš„"å¯¼å…¥æ•°æ®"åŠŸèƒ½æ¢å¤', 'info');
    } else {
        alert('ä¸“æ³¨æ—¶é’Ÿæ•°æ®å¯¼å‡ºæˆåŠŸï¼Œå¯é€šè¿‡è®¾ç½®é¡µé¢çš„"å¯¼å…¥æ•°æ®"åŠŸèƒ½æ¢å¤');
    }
}
function showImportHint() {
    if (window.showNotification) {
        showNotification('è¯·é€‰æ‹©é€šè¿‡è®¾ç½®é¡µé¢"å¤‡ä»½æ•°æ®"åŠŸèƒ½å¯¼å‡ºçš„JSONæ–‡ä»¶è¿›è¡Œå¯¼å…¥', 'info');
    } else {
        alert('è¯·é€‰æ‹©é€šè¿‡è®¾ç½®é¡µé¢"å¤‡ä»½æ•°æ®"åŠŸèƒ½å¯¼å‡ºçš„JSONæ–‡ä»¶è¿›è¡Œå¯¼å…¥');
    }
}
    </script>
</body>
</html>